<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defibrillator Training - ××™××•×Ÿ ×“×¤×™×‘×¨×™×œ×˜×•×¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, 'Arial', 'Traditional Arabic', sans-serif;
            background: #000;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: relative;
            direction: rtl;
        }

        /* RTL/LTR support */
        body.ltr {
            direction: ltr;
        }

        body.rtl {
            direction: rtl;
        }

        /* Better Arabic font support */
        body[lang="ar"],
        body[lang="ar"] * {
            font-family: 'Traditional Arabic', 'Arial', 'Segoe UI', Tahoma, sans-serif;
        }

        /* Hebrew font support */
        body[lang="he"],
        body[lang="he"] * {
            font-family: 'Arial', 'David', 'Segoe UI', Tahoma, sans-serif;
        }

        /* English font support */
        body[lang="en"],
        body[lang="en"] * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Hide all screens by default */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .screen.active {
            display: flex;
            opacity: 1;
        }

        /* Idle Screen */
        #idle-screen {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* Stage 1: Opening Animation */
        #stage1-screen {
            background: #000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .story-text {
            color: #fff;
            font-size: 3em;
            text-align: right;
            padding: 40px;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.8);
            direction: rtl;
            width: 100%;
            line-height: 1.8;
        }

        /* ×¡×’× ×•×Ÿ ×œ×¤×ª×™×— - ×˜×§×¡×˜ ×’×“×•×œ ×‘××¨×›×– */
        .story-text.intro-style {
            font-size: 5em;
            text-align: center;
            font-weight: bold;
            line-height: 1.5;
        }

        /* ×¡×’× ×•×Ÿ ×œ×¡×™×¤×•×¨ ×”×¨××©×™ - ×˜×§×¡×˜ ×’×“×•×œ ×™×•×ª×¨ ××¢×˜ ×©×××œ×” */
        .story-text.main-style {
            font-size: 4.5em;
            text-align: right;
            padding-right: 200px;
        }

        /* ×¡×’× ×•×Ÿ ×œ×ª×•×•×™× ×‘×•×“×“×™× ×‘××¤×§×˜ ××›×•× ×ª ×”×›×ª×™×‘×” */
        .typewriter-char {
            opacity: 0;
            transition: opacity 0.05s ease;
        }

        .fade-in {
            animation: fadeIn 2s ease-in forwards;
        }

        .fade-to-black {
            animation: fadeToBlack 2s ease-in forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeToBlack {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Video Screens */
        #video1-screen, #video2-screen {
            background: #000;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Stage 2: Instructions */
        #stage2-screen {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .instruction-title {
            color: white;
            font-size: 4em;
            font-weight: bold;
            text-shadow: 3px 3px 10px rgba(0,0,0,0.5);
            margin-bottom: 40px;
            animation: pulse 2s infinite;
            text-align: center;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .def-image {
            max-width: 80%;
            max-height: 50vh;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            margin-bottom: 40px;
        }

        .instruction-text {
            color: white;
            font-size: 3em;
            text-align: center;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }

        /* Stage 3: Shock Ready */
        #stage3-screen {
            background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .shock-title {
            color: #d32f2f;
            font-size: 4em;
            font-weight: bold;
            text-shadow: 3px 3px 10px rgba(0,0,0,0.5);
            margin-bottom: 40px;
            animation: blink 1s infinite;
            text-align: center;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }

        .shock-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Stage 5: Success Screen */
        #stage5-screen {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            position: relative;
        }

        .success-title {
            color: white;
            font-size: 5em;
            font-weight: bold;
            text-shadow: 3px 3px 15px rgba(0,0,0,0.5);
            margin-bottom: 40px;
            animation: celebration 1s ease-in-out infinite;
            text-align: center;
            z-index: 5;
        }

        @keyframes celebration {
            0%, 100% { transform: rotate(-5deg) scale(1); }
            50% { transform: rotate(5deg) scale(1.1); }
        }

        .health-image {
            max-width: 70%;
            max-height: 50vh;
            border-radius: 30px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.4);
            margin-bottom: 40px;
            animation: zoomIn 1s ease-out;
            z-index: 5;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Fireworks Animation */
        .fireworks {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .firework {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: explode 1.5s ease-out forwards;
        }

        @keyframes explode {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty));
                opacity: 0;
            }
        }

        /* Confetti */
        .confetti {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--color);
            animation: confettiFall 4s linear forwards;
            z-index: 2;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Debug Info */
        #debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
            z-index: 1000;
            display: none; /* Set to 'block' for debugging */
        }
    </style>
</head>
<body>
    <!-- Debug Info -->
    <div id="debug-info">
        <div>Current Stage: <span id="debug-stage">idle</span></div>
        <div>Language: <span id="debug-lang">none</span></div>
        <div>Timeout Active: <span id="debug-timeout">yes</span></div>
    </div>

    <!-- Idle Screen -->
    <div id="idle-screen" class="screen active"></div>

    <!-- Stage 1: Opening Animation + Text -->
    <div id="stage1-screen" class="screen">
        <div class="story-text" id="story-text"></div>
    </div>

    <!-- Video 1 Screen -->
    <div id="video1-screen" class="screen">
        <video id="video1" preload="auto">
            <source src="vid/1.mp4" type="video/mp4">
        </video>
    </div>

    <!-- Stage 2: Instructions -->
    <div id="stage2-screen" class="screen">
        <h1 class="instruction-title" id="stage2-title"></h1>
        <img src="images/def1.png" alt="Defibrillator" class="def-image">
        <p class="instruction-text" id="stage2-instruction"></p>
    </div>

    <!-- Middle Video Screen -->
    <div id="middle-video-screen" class="screen">
        <video id="middle-video" preload="auto">
            <source src="vid/middle.mp4" type="video/mp4">
        </video>
    </div>

    <!-- Stage 3: Shock Ready - Wait for D2 -->
    <div id="stage3-screen" class="screen">
        <h1 class="shock-title" id="stage3-title"></h1>
        <p class="instruction-text" id="stage3-instruction"></p>
    </div>

    <!-- End Video Screen (after shock) -->
    <div id="end-video-screen" class="screen">
        <video id="end-video" preload="auto">
            <source src="vid/end.mp4" type="video/mp4">
        </video>
    </div>

    <!-- Stage 5: Success Screen -->
    <div id="stage5-screen" class="screen">
        <div class="fireworks" id="fireworks-container"></div>
        <h1 class="success-title" id="stage5-title"></h1>
        <img src="images/health.png" alt="Success" class="health-image">
    </div>

    <script>
        // =====================================
        // Configuration & Translations
        // =====================================

        const CONFIG = {
            IDLE_TIMEOUT_MS: 2 * 60 * 1000, // 2 minutes
            TYPEWRITER_CHAR_DELAY: 80, // 80ms between each character in typewriter effect
            FADE_TO_BLACK_DURATION: 2000, // 2 seconds fade
            COUNTDOWN_DURATION: 5000, // countdown.wav - 5 seconds
            DEFI_DURATION: 3000, // defi.wav - 3 seconds
            SUCCESS_DURATION: 10000, // Success screen display time
        };

        const TRANSLATIONS = {
            he: {
                storyIntro: "×ª×œ ××‘×™×‘, ×™×©×¨××œ",
                storyIntro2: "2025",
                storyMain: "×‘×§× ×™×•×Ÿ ×¨××ª ××‘×™×‘, ×”×ª×”×œ×›×• ×œ×”× ×”×–×•×’ ×”×—×‘×™×‘ ×‘× ×™ ×•×“×‘×™",
                stage2Title: "×”×“×¤×™×‘×¨×™×œ×˜×•×¨ ×‘×™×“×›×!!",
                stage2Instruction: "×›×¢×ª ×§×—×• ××ª ×”×›×¤×•×ª ×•×”×“×‘×™×§×• ×œ××™×©!!",
                stage3Title: "âš¡ ××•×›× ×™× ×œ×ª×ª ×©×•×§ ×—×©××œ×™! âš¡",
                stage3Instruction: "×œ×—×¦×• ×¢×œ ×”×›×¤×ª×•×¨ ×‘×¦×“ ×œ×ª×ª ×©×•×§ ×—×©××œ×™!",
                stage5Title: "×‘×¨×›×•×ª, ×”×¦×œ×ª× ××ª ×‘× ×™!!"
            },
            en: {
                storyIntro: "Tel Aviv, Israel",
                storyIntro2: "2025",
                storyMain: "At Ramat Aviv Mall, the lovely couple Benny and Debby were walking",
                stage2Title: "The Defibrillator is in Your Hands!!",
                stage2Instruction: "Now take the pads and attach them to the person!!",
                stage3Title: "âš¡ Ready to Give Electric Shock! âš¡",
                stage3Instruction: "Press the button on the side to deliver the shock!",
                stage5Title: "Congratulations, You Saved the Nice Guy!!"
            },
            ar: {
                storyIntro: "ØªÙ„ Ø£Ø¨ÙŠØ¨ØŒ Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„",
                storyIntro2: "2025",
                storyMain: "ÙÙŠ Ù…Ø±ÙƒØ² Ø±Ù…Ø§Øª Ø£ÙÙŠÙ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØŒ ÙƒØ§Ù† Ø§Ù„Ø²ÙˆØ¬Ø§Ù† Ø§Ù„Ù„Ø·ÙŠÙØ§Ù† Ø¨ÙŠÙ†ÙŠ ÙˆØ¯ÙŠØ¨ÙŠ ÙŠØªØ¬ÙˆÙ„Ø§Ù†",
                stage2Title: "Ø¬Ù‡Ø§Ø² Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø¬ÙØ§Ù† Ø¨ÙŠÙ† ÙŠØ¯ÙŠÙƒ!!",
                stage2Instruction: "Ø§Ù„Ø¢Ù† Ø®Ø° Ø§Ù„Ø£Ù‚Ø·Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© ÙˆØ£Ù„ØµÙ‚Ù‡Ø§ Ø¨Ø§Ù„Ø´Ø®Øµ!!",
                stage3Title: "âš¡ Ø¬Ø§Ù‡Ø² Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØµØ¯Ù…Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©! âš¡",
                stage3Instruction: "Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØµØ¯Ù…Ø©!",
                stage5Title: "ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ØŒ Ù„Ù‚Ø¯ Ø£Ù†Ù‚Ø°Øª Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù„Ø·ÙŠÙ!!"
            }
        };

        // =====================================
        // State Management
        // =====================================

        let currentStage = 'idle';
        let currentLanguage = 'he'; // Start with Hebrew
        let timeoutTimer = null;
        let isTimeoutPaused = false;
        const languageOrder = ['he', 'en', 'ar']; // Language cycling order

        // =====================================
        // Timeout Management
        // =====================================

        function resetTimeout() {
            if (isTimeoutPaused) return;

            clearTimeout(timeoutTimer);
            timeoutTimer = setTimeout(() => {
                goToIdle();
            }, CONFIG.IDLE_TIMEOUT_MS);
            updateDebug();
        }

        function pauseTimeout() {
            isTimeoutPaused = true;
            clearTimeout(timeoutTimer);
            updateDebug();
        }

        function resumeTimeout() {
            isTimeoutPaused = false;
            resetTimeout();
        }

        function goToIdle() {
            console.log('â° Timeout - Going to idle screen');
            currentStage = 'idle';
            currentLanguage = 'he'; // Reset to Hebrew

            // Reset to RTL (Hebrew)
            updateTextDirection();

            showScreen('idle-screen');
            pauseTimeout();
            updateDebug();
        }

        // =====================================
        // Screen Transitions
        // =====================================

        function showScreen(screenId) {
            console.log('ğŸ–¥ï¸  Showing screen:', screenId);

            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Show target screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.style.display = 'flex';
                targetScreen.offsetHeight; // Trigger reflow
                targetScreen.classList.add('active');
            }

            updateDebug();
        }

        // =====================================
        // Keyboard Listener
        // =====================================

        const keyMap = {
            'Numpad1': 'D1',
            'Numpad2': 'D2',
            'Numpad3': 'D3',
            'Numpad4': 'D4',
            'Numpad5': 'D5',
            'Numpad6': 'D6',
            'Digit1': 'D1',
            'Digit2': 'D2',
            'Digit3': 'D3',
            'Digit4': 'D4',
            'Digit5': 'D5',
            'Digit6': 'D6'
        };

        document.addEventListener('keydown', function(event) {
            const keyCode = event.code;
            const mappedKey = keyMap[keyCode];

            if (mappedKey) {
                console.log('âŒ¨ï¸  Key pressed:', mappedKey);
                handleKeyPress(mappedKey);
            }
        });

        function handleKeyPress(key) {
            // Reset timeout on any interaction (except during videos)
            if (!isTimeoutPaused) {
                resetTimeout();
            }

            // D1 - Start app OR cycle language
            if (key === 'D1') {
                if (currentStage === 'idle') {
                    // First press - start the app with current language (Hebrew)
                    startStage1();
                } else {
                    // Cycle to next language
                    cycleLanguage();
                }
                return;
            }

            // Stage-specific actions
            switch (currentStage) {
                case 'stage2':
                    // D4 OR D6 = Pads placed on body - manually advance to middle video
                    if (key === 'D4' || key === 'D6') {
                        console.log('ğŸ©º Pads connected to body (D4/D6 detected) - playing middle video');
                        playMiddleVideo();
                    }
                    break;

                case 'stage3':
                    if (key === 'D2') {
                        // D2 = Give shock button pressed
                        performShock();
                    }
                    break;
            }
        }

        // =====================================
        // Language Selection
        // =====================================

        function cycleLanguage() {
            const currentIndex = languageOrder.indexOf(currentLanguage);
            const nextIndex = (currentIndex + 1) % languageOrder.length;
            currentLanguage = languageOrder[nextIndex];

            console.log('ğŸŒ Language cycled to:', currentLanguage);

            // Update text direction for RTL/LTR
            updateTextDirection();

            // Update all text on screen if we're in a stage with text
            updateCurrentStageText();
            updateDebug();
        }

        function updateTextDirection() {
            const body = document.body;
            const html = document.documentElement;

            if (currentLanguage === 'en') {
                // English = LTR
                body.classList.remove('rtl');
                body.classList.add('ltr');
                html.setAttribute('dir', 'ltr');
                html.setAttribute('lang', 'en');
                console.log('ğŸ“ Text direction set to LTR (English)');
            } else {
                // Hebrew and Arabic = RTL
                body.classList.remove('ltr');
                body.classList.add('rtl');
                html.setAttribute('dir', 'rtl');
                html.setAttribute('lang', currentLanguage);
                console.log('ğŸ“ Text direction set to RTL (' + currentLanguage + ')');
            }
        }

        function updateCurrentStageText() {
            // Update text based on current stage
            if (currentStage === 'stage1') {
                // ×× ××©× ×™× ×©×¤×” ×‘-stage1, ××¤×¢×™×œ×™× ××ª ×”××¤×§×˜ ××—×“×© ××”×”×ª×—×œ×”
                typewriterIntro();
            } else if (currentStage === 'stage2') {
                document.getElementById('stage2-title').textContent = TRANSLATIONS[currentLanguage].stage2Title;
                document.getElementById('stage2-instruction').textContent = TRANSLATIONS[currentLanguage].stage2Instruction;
            } else if (currentStage === 'stage3') {
                document.getElementById('stage3-title').textContent = TRANSLATIONS[currentLanguage].stage3Title;
                const stage3Instruction = document.getElementById('stage3-instruction');
                if (stage3Instruction) {
                    stage3Instruction.textContent = TRANSLATIONS[currentLanguage].stage3Instruction;
                }
            } else if (currentStage === 'stage5') {
                document.getElementById('stage5-title').textContent = TRANSLATIONS[currentLanguage].stage5Title;
            }
        }

        // =====================================
        // Stage 1: Opening Animation
        // =====================================

        function startStage1() {
            console.log('ğŸ¬ Starting Stage 1: Opening Animation');
            currentStage = 'stage1';

            // Set text direction based on current language
            updateTextDirection();

            showScreen('stage1-screen');

            // ×©×œ×‘ 1: ×”×¦×’×ª "×ª×œ ××‘×™×‘, 2025"
            typewriterIntro();
        }

        function typewriterIntro() {
            const storyText = document.getElementById('story-text');
            const introText = TRANSLATIONS[currentLanguage].storyIntro;
            const intro2Text = TRANSLATIONS[currentLanguage].storyIntro2;

            // ×”××ª×Ÿ 2.5 ×©× ×™×•×ª ×œ×¤× ×™ ×ª×—×™×œ×ª ×›×œ ×”×¤×ª×™×—
            setTimeout(() => {
                // × ×™×§×•×™ ×”×˜×§×¡×˜ ×”×§×™×™×
                storyText.innerHTML = '';
                storyText.className = 'story-text intro-style'; // ×¡×’× ×•×Ÿ ×¤×ª×™×—
                storyText.style.opacity = '0';

                // ×”×•×¡×¤×ª fade-in
                storyText.classList.add('fade-in');

                // ×”×©××¢×ª ×§×¨×™×™× ×•×ª - ×ª×œ ××‘×™×‘, ×™×©×¨××œ ×¢× ×“×™×œ×™×™ ×©×œ 1.5 ×©× ×™×•×ª
                setTimeout(() => {
                    playSound('sound/israel.mp3');
                }, 1500);

                // ×¤×™×¦×•×œ ×”×˜×§×¡×˜ ×œ×ª×•×•×™× ×‘×•×“×“×™× - ×”×—×œ×§ ×”×¨××©×•×Ÿ
                const chars = introText.split('');

                // ×™×¦×™×¨×ª span ×œ×›×œ ×ª×•
                chars.forEach((char) => {
                    const span = document.createElement('span');
                    span.className = 'typewriter-char';
                    span.textContent = char;
                    span.style.opacity = '0';
                    storyText.appendChild(span);
                });

                // ×™×¨×™×“×ª ×©×•×¨×”
                storyText.appendChild(document.createElement('br'));

                // ×¤×™×¦×•×œ ×”×˜×§×¡×˜ ×œ×ª×•×•×™× ×‘×•×“×“×™× - 2025
                const chars2 = intro2Text.split('');
                chars2.forEach((char) => {
                    const span = document.createElement('span');
                    span.className = 'typewriter-char typewriter-char-2025';
                    span.textContent = char;
                    span.style.opacity = '0';
                    storyText.appendChild(span);
                });

                // ×”××ª×Ÿ ×œ×¡×™×•× fade-in ×•××– ×”×ª×—×œ ×”×§×œ×“×”
                setTimeout(() => {
                    // ×”×¦×’×ª ×ª×•×•×™× ××—×“ ××—×¨×™ ×”×©× ×™ - ×”×—×œ×§ ×”×¨××©×•×Ÿ
                    const spans = storyText.querySelectorAll('.typewriter-char:not(.typewriter-char-2025)');
                    let charIndex = 0;

                    const typingInterval = setInterval(() => {
                        if (charIndex < spans.length) {
                            spans[charIndex].style.opacity = '1';
                            charIndex++;
                        } else {
                            clearInterval(typingInterval);

                            // ×”××ª×Ÿ ×—×¦×™ ×©× ×™×” ×•××– ×”×¦×’ ××ª 2025
                            setTimeout(() => {
                                const spans2025 = storyText.querySelectorAll('.typewriter-char-2025');
                                let char2025Index = 0;

                                const typing2025Interval = setInterval(() => {
                                    if (char2025Index < spans2025.length) {
                                        spans2025[char2025Index].style.opacity = '1';
                                        char2025Index++;
                                    } else {
                                        clearInterval(typing2025Interval);

                                        // ×”××ª×Ÿ ×¨×’×¢, ×•××– ×”×¢×œ× ×•×”××©×š ×œ×˜×§×¡×˜ ×”×¨××©×™
                                        setTimeout(() => {
                                            storyText.classList.remove('fade-in');
                                            storyText.classList.add('fade-to-black');

                                            setTimeout(() => {
                                                storyText.classList.remove('fade-to-black');
                                                typewriterMain();
                                            }, CONFIG.FADE_TO_BLACK_DURATION);
                                        }, 1000); // ×”××ª×Ÿ ×©× ×™×™×” ×œ××—×¨ ×¡×™×•× ×”×”×§×œ×“×”
                                    }
                                }, CONFIG.TYPEWRITER_CHAR_DELAY);
                            }, 500); // ×“×™×œ×™×™ ×©×œ ×—×¦×™ ×©× ×™×” ×œ×¤× ×™ 2025
                        }
                    }, CONFIG.TYPEWRITER_CHAR_DELAY);
                }, CONFIG.FADE_TO_BLACK_DURATION); // ×”××ª×Ÿ ×œ×¡×™×•× fade-in
            }, 2500); // ×“×™×œ×™×™ ×©×œ 2.5 ×©× ×™×•×ª ×œ×¤× ×™ ×ª×—×™×œ×ª ×”×¤×ª×™×—
        }

        function typewriterMain() {
            const storyText = document.getElementById('story-text');
            const mainText = TRANSLATIONS[currentLanguage].storyMain;

            // × ×™×§×•×™ ×”×˜×§×¡×˜ ×”×§×™×™×
            storyText.innerHTML = '';
            storyText.className = 'story-text main-style'; // ×¡×’× ×•×Ÿ ×¡×™×¤×•×¨ ×¨××©×™
            storyText.style.opacity = '0';

            // ×”×•×¡×¤×ª fade-in
            storyText.classList.add('fade-in');

            // ×”×©××¢×ª ×§×¨×™×™× ×•×ª - ×¡×™×¤×•×¨ ×‘× ×™ ×•×“×‘×™ ×¢× ×“×™×œ×™×™ ×©×œ 1.7 ×©× ×™×•×ª
            setTimeout(() => {
                playSound('sound/benny.mp3');
            }, 1700);

            // ×¤×™×¦×•×œ ×”×˜×§×¡×˜ ×œ×ª×•×•×™× ×‘×•×“×“×™×
            const chars = mainText.split('');

            // ×™×¦×™×¨×ª span ×œ×›×œ ×ª×•
            chars.forEach((char) => {
                const span = document.createElement('span');
                span.className = 'typewriter-char';
                span.textContent = char;
                span.style.opacity = '0';
                storyText.appendChild(span);
            });

            // ×”××ª×Ÿ ×œ×¡×™×•× fade-in ×•××– ×”×ª×—×œ ×”×§×œ×“×”
            setTimeout(() => {
                // ×”×¦×’×ª ×ª×•×•×™× ××—×“ ××—×¨×™ ×”×©× ×™
                const spans = storyText.querySelectorAll('.typewriter-char');
                let charIndex = 0;

                const typingInterval = setInterval(() => {
                    if (charIndex < spans.length) {
                        spans[charIndex].style.opacity = '1';
                        charIndex++;
                    } else {
                        clearInterval(typingInterval);

                        // ×œ××—×¨ ×¡×™×•× ×”×”×§×œ×“×”, ×”××ª×Ÿ ×¨×’×¢ ×•×¢×‘×•×¨ ×œ×¡×¨×˜×•×Ÿ
                        setTimeout(() => {
                            storyText.classList.remove('fade-in');
                            storyText.classList.add('fade-to-black');

                            setTimeout(() => {
                                playVideo1();
                            }, CONFIG.FADE_TO_BLACK_DURATION);
                        }, 1000); // ×”××ª×Ÿ ×©× ×™×™×” ×œ××—×¨ ×¡×™×•× ×”×”×§×œ×“×”
                    }
                }, CONFIG.TYPEWRITER_CHAR_DELAY);
            }, CONFIG.FADE_TO_BLACK_DURATION); // ×”××ª×Ÿ ×œ×¡×™×•× fade-in
        }

        // =====================================
        // Video 1
        // =====================================

        function playVideo1() {
            console.log('ğŸ¥ Playing Video 1');
            currentStage = 'video1';
            pauseTimeout(); // Don't count timeout during video
            showScreen('video1-screen');

            const video = document.getElementById('video1');
            video.currentTime = 0;
            video.play().catch(err => console.error('Video 1 play error:', err));

            video.onended = () => {
                console.log('âœ… Video 1 ended');
                resumeTimeout();
                startStage2();
            };
        }

        // =====================================
        // Stage 2: Instructions
        // =====================================

        function startStage2() {
            console.log('ğŸ“‹ Starting Stage 2: Instructions');
            currentStage = 'stage2';
            resetTimeout();
            showScreen('stage2-screen');

            document.getElementById('stage2-title').textContent = TRANSLATIONS[currentLanguage].stage2Title;
            document.getElementById('stage2-instruction').textContent = TRANSLATIONS[currentLanguage].stage2Instruction;

            // ×”×©××¢×ª ×§×•×œ ×”×“×¤×™×‘×¨×™×œ×˜×•×¨
            playSound('sound/defi.mp3');

            // Wait for D6/D4 button press - handled by keyboard listener
        }

        // =====================================
        // Middle Video (between stage2 and stage3)
        // =====================================

        function playMiddleVideo() {
            console.log('ğŸ¥ Playing Middle Video');
            currentStage = 'middle-video';
            pauseTimeout(); // Don't count timeout during video
            showScreen('middle-video-screen');

            const video = document.getElementById('middle-video');
            video.currentTime = 0;
            video.play().catch(err => console.error('Middle video play error:', err));

            video.onended = () => {
                console.log('âœ… Middle video ended');
                resumeTimeout();
                startStage3();
            };
        }

        // =====================================
        // Stage 3: Ready for Shock - Wait for D2
        // =====================================

        function startStage3() {
            console.log('âš¡ Starting Stage 3: Ready for Shock - Waiting for D2');
            currentStage = 'stage3';
            resetTimeout();
            showScreen('stage3-screen');

            document.getElementById('stage3-title').textContent = TRANSLATIONS[currentLanguage].stage3Title;
            document.getElementById('stage3-instruction').textContent = TRANSLATIONS[currentLanguage].stage3Instruction;

            // ×”×©××¢×ª ×§×•×œ ××•×›×Ÿ ×œ×©×•×§
            playSound('sound/shock.mp3');

            // Wait for D2 button press - handled by keyboard listener
        }

        function performShock() {
            if (currentStage !== 'stage3') {
                return;
            }

            console.log('âš¡âš¡âš¡ Performing Shock! Playing end video...');
            playEndVideo();
        }

        // =====================================
        // End Video (after shock button pressed)
        // =====================================

        function playEndVideo() {
            console.log('ğŸ¥ Playing End Video');
            currentStage = 'end-video';
            pauseTimeout(); // Don't count timeout during video
            showScreen('end-video-screen');

            const video = document.getElementById('end-video');
            video.currentTime = 0;
            video.play().catch(err => console.error('End video play error:', err));

            video.onended = () => {
                console.log('âœ… End video ended');
                startStage5();
            };
        }

        // =====================================
        // Audio Player
        // =====================================

        function playSound(src) {
            console.log('ğŸ”Š Playing sound:', src);
            const audio = new Audio(src);
            audio.play().catch(err => {
                console.error('Error playing sound:', err);
            });
        }

        // =====================================
        // Stage 5: Success Screen
        // =====================================

        function startStage5() {
            console.log('ğŸ‰ Starting Stage 5: Success!');
            currentStage = 'stage5';
            pauseTimeout();
            showScreen('stage5-screen');

            document.getElementById('stage5-title').textContent = TRANSLATIONS[currentLanguage].stage5Title;

            // ×”×©××¢×ª ×‘×¨×›×•×ª
            playSound('sound/brachot.mp3');

            // Create fireworks and confetti
            createFireworks();
            createConfetti();

            // After success duration, return to idle
            setTimeout(() => {
                goToIdle();
            }, CONFIG.SUCCESS_DURATION);
        }

        // =====================================
        // Fireworks Animation
        // =====================================

        function createFireworks() {
            const container = document.getElementById('fireworks-container');
            container.innerHTML = '';

            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffffff', '#ffa500'];

            // Create multiple fireworks bursts
            for (let burst = 0; burst < 15; burst++) {
                setTimeout(() => {
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * (window.innerHeight / 2);

                    for (let i = 0; i < 40; i++) {
                        const firework = document.createElement('div');
                        firework.className = 'firework';
                        firework.style.left = x + 'px';
                        firework.style.top = y + 'px';
                        firework.style.background = colors[Math.floor(Math.random() * colors.length)];

                        const angle = (Math.PI * 2 * i) / 40;
                        const velocity = 100 + Math.random() * 150;
                        const tx = Math.cos(angle) * velocity;
                        const ty = Math.sin(angle) * velocity;

                        firework.style.setProperty('--tx', tx + 'px');
                        firework.style.setProperty('--ty', ty + 'px');

                        container.appendChild(firework);

                        setTimeout(() => {
                            firework.remove();
                        }, 1500);
                    }
                }, burst * 400);
            }
        }

        function createConfetti() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#ff1493'];

            for (let i = 0; i < 150; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = '-10px';
                    confetti.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]);
                    confetti.style.animationDelay = Math.random() * 3 + 's';

                    document.body.appendChild(confetti);

                    setTimeout(() => {
                        confetti.remove();
                    }, 4000);
                }, i * 60);
            }
        }

        // =====================================
        // Debug Info
        // =====================================

        function updateDebug() {
            document.getElementById('debug-stage').textContent = currentStage;
            document.getElementById('debug-lang').textContent = currentLanguage || 'none';
            document.getElementById('debug-timeout').textContent = isTimeoutPaused ? 'paused' : 'active';
        }

        // =====================================
        // Initialization
        // =====================================

        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ® Defibrillator Training App Initialized');
            console.log('ğŸ“¦ Configuration:', CONFIG);

            // Set idle screen background
            const idleScreen = document.getElementById('idle-screen');
            idleScreen.style.backgroundImage = 'url(images/idle.png)';

            // Start with idle screen and timeout
            currentStage = 'idle';
            showScreen('idle-screen');
            resetTimeout();

            console.log('âœ… Ready!');
            console.log('Press D1 to start (Hebrew default)');
            console.log('Press D1 again to cycle languages: Hebrew â†’ English â†’ Arabic');
        });
    </script>
</body>
</html>
